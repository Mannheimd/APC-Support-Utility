<!DOCTYPE html>
<html>

<head>
    <title>Act! Premium Cloud Support Utility | Start Page</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">

    <style>
        #configuredServers .ui-selecting {
            background: #c3c3c3;
        }
        
        #configuredServers .ui-selected {
            background: #878787;
            color: white;
        }
        
        #configuredServers {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <script>
        var environmentList = []; //Lists all of the available Jenkins environments

        // On page load, read /resources/data/jenkinsEnvironments.xml for the list of Jenkins environments that are available to connect to.
        $(document).ready(function() {
            loadJenkinsEnvironmentsXml()
        });


        /* Pulls data from the jenkinsEnvironments.xml

        Called by:
        $(document).ready()
        */
        function loadJenkinsEnvironmentsXml() {
            $.ajax({
                type: "GET",
                url: "resources/data/jenkinsEnvironments.xml",
                async: true,
                dataType: "xml",
                success: (function(data) {
                    readJenkinsEnvironmentsXml(data); // Pass the output for parsing
                })
            });
        }


        /* Get Jenkins environment data from the XML

        Called by:
        loadJenkinsEnvironmentsXml()
        */
        function readJenkinsEnvironmentsXml(xmlData) {
            $(xmlData).find('environment').each(function() {
                var name = $(this).find("name").text(),
                    id = $(this).find("id").text(),
                    isProduction = $(this).find("isProduction").text(),
                    url = $(this).find("url").text();

                environmentList[environmentList.length] = ({
                    name: name,
                    id: id,
                    isProduction: isProduction,
                    url: url
                });
            });

            checkConfiguredJenkinsEnvironments();
        }


        /* Check which environments have a stored login token

        Called by:
        readJenkinsEnvironmentsXml()
        */
        function checkConfiguredJenkinsEnvironments() {
            var configuredEnvsHtml = "";

            $(environmentList).each(function() {
                if (localStorage.getItem(this.id + "LoginToken")) {
                    configuredEnvsHtml = configuredEnvsHtml + '<li id="envSelector' + this.id + '">' + this.name + '</li>';
                    getJenkinsUserInfo(this.id);
                }
            });

            $("#configuredServers")
                .html(configuredEnvsHtml)
                .selectable({
                    selected: function(event, ui) {
                        $(ui.selected).addClass("ui-selected").siblings().removeClass("ui-selected").each(
                            function(key, value) {
                                $(value).find('*').removeClass("ui-selected");
                            }
                        )
                    }
                })
        }


        /* For each 'configured' Jenkins server, test login

        Called by:
        checkConfiguredJenkinsEnvironments()
        */
        function getJenkinsUserInfo(environmentId) {
            var requestUrl = "";
            var authToken = "Basic " + localStorage.getItem(environmentId + "LoginToken");

            $(environmentList).each(function() {
                if (this.id == environmentId) {
                    requestUrl = this.url + "/me/api/xml";
                    $.ajax({
                        method: "GET",
                        url: requestUrl,
                        async: true,
                        crossDomain: true,
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader("Authorization", "Basic Y21hbmRlcnMudGVjaDphNDczMjVmMGU5ZDhhODc3NTc2ZWRkNjg3ZmExYTdiNA==");
                        },
                        dataType: "text",
                        success: (function(data) {
                            $("#tempOutput").html(data);
                        }),
                        error: (function() {
                            alert("Failed")
                        })
                    });

                    /*$.ajax({
                        method: "GET",
                        url: "resources/php/apirequester.php?url=" + requestUrl + "&token=" + authToken,
                        async: true,
                        dataType: "text",
                        success: (function(data) {
                            var xmlData = $.parseXML(data);
                            $xml = $(xmlData);
                            readJenkinsUserData($xml, environmentId);
                        }),
                        error: (function() {
                            var elementId = "envSelector" + environmentId;
                            $("#" + elementId).append(" - Connection failed");
                        })
                    })*/
                }
            });
        }

        function readJenkinsUserData($xml, environmentId) {
            var fullname = $xml.find('user property user fullName').text();

            var elementId = "envSelector" + environmentId;
            $("#" + elementId).append(" - " + fullname);
        }
    </script>
    <span>
    <h1>Welcome to the Act! Premium Cloud Support Utility</h1>
</span>
    <span>
    <h3>Select a Jenkins server:</h3><button id="configureButton" onclick="location.href = pageContainer + '/jenkinslogin.html';">Configure</button>
    <ul id="configuredServers">
    </ul>
</span>
    <p id="tempOutput"></p>

</body>

</html>