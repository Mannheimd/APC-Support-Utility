<!DOCTYPE html>
<html>

<head>
    <title>Act! Premium Cloud Support Utility | Jenkins Login</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>

<body>
    <script>
        function getJenkinsUserInfo(environmentId) {
            /* For each 'configured' Jenkins server, run a GET request to pull the user's data from Jenkins

            Called by:
            checkConfiguredJenkinsEnvironments()
            */

            var requestUrl = "";
            var authToken = "Basic " + localStorage.getItem(environmentId + "LoginToken");

            $(environmentList).each(function() {
                if (this.id == environmentId) {
                    requestUrl = this.url + "/me/api/xml";
                    $.ajax({
                        method: "GET",
                        url: requestUrl,
                        async: true,
                        crossDomain: true,
                        beforeSend: function(xhr) {
                            xhr.setRequestHeader("Authorization", authToken);
                        },
                        dataType: "text",
                        success: (function(data) {
                            var xmlData = $.parseXML(data);
                            $xml = $(xmlData);
                            readJenkinsUserData($xml, environmentId);
                        }),
                        error: (function() {
                            var elementId = "envSelector" + environmentId;
                            $("#" + elementId).append(' - Connection failed');
                        })
                    });
                }
            });
        }

        function readJenkinsUserData($xml, environmentId) {
            /* Read the username from the passed XML, print it next to the server name

            Called by:
            getJenkinsUserInfo()
            */
            var fullname = $xml.find('user property user fullName').text();

            var elementId = "envSelector" + environmentId;
            $("#" + elementId).append(" - " + fullname);
        }

        function populateEnvironmentSelect() {
            $(environmentList).each(function() {
                $("#environmentSelect").append($('<option>', {
                    value: this.id,
                    text: this.name
                }))
            })
        }
        
        function submitForm() {
            var loginToken = window.btoa($("#userNameBox").val() + ":" + $("#apiTokenBox").val());
            localStorage.setItem($("#environmentSelect").val() + "LoginToken", loginToken);
            location.reload();
        }
    </script>
    <h1>
        Configure your Jenkins server logins
    </h1>
    <div>
        <p>Current server status:</p>
        <ul id="configuredServers">
        </ul>
    </div>
    <div>
        <p id="step1">
            1. Choose a server:
            <select id="environmentSelect" onchange="onEnvironmentSelectChange()">
            <option disabled selected value="default">Select a server</option>
        </select>
        </p>
        <p hidden id="step2">
        </p>
        <p hidden id="step3">
            3. Log in using the credentials you were provided for this Jenkins server
        </p>
        <p hidden id="step4">
            4. Click the "Show API Token" button
        </p>
        <form hidden id="step5" action="javascript:submitForm();">
            5. Copy the User ID and API Token into the boxes below<br/> User ID: <input type="username" name="User ID" id="userNameBox"><br/> API Token: <input type="password" name="API Token" id="apiTokenBox"><br/><br/> 6. Save your changes
            <Input type="submit" value="Save">
        </form>
    </div>
</body>

</html>